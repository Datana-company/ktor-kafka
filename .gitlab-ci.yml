#image: adoptopenjdk/openjdk11:alpine-slim
image: docker:git
#image: registry.datana.ru/alpine-java-docker

services:
    - docker:dind

variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    # DOCKER_HOST: tcp://docker:2375
    JAVA_IMAGE: adoptopenjdk/openjdk11:alpine-slim

stages:
    #    - build
    - test
    - deploy

before_script:
    - echo `pwd` # debug
    - docker info
    - echo "$CI_BUILD_NAME, $CI_BUILD_REF_NAME $CI_BUILD_STAGE" # debug
    - export GRADLE_USER_HOME=`pwd`/.gradle

cache:
    paths:
        - .gradle/wrapper
        - .gradle/caches

#build:
#    stage: build
#    script:
#        - ./gradlew build
#    only:
#        - master

test:
    image: adoptopenjdk/openjdk11:alpine-slim
    stage: test
    script:
        - ./gradlew check
    only:
        - /^feature\/.*$/

deploy:
    stage: deploy
    script:
        - echo "$CI_REGISTRY_PASSWORD" | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
        - docker run --rm -v /var/run/docker.sock:/var/run/docker.sock $JAVA_IMAGE ./gradlew deploy
    only:
        - dev

after_script:
    - echo "End CI"
